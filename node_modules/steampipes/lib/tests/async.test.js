// Generated by CoffeeScript 2.5.1
(function() {
  'use strict';
  var $, $async, $drain, $send_three, $show, $watch, CND, SP, after, badge, debug, defer, echo, help, info, jr, rpr, sleep, test, urge, warn, whisper,
    indexOf = [].indexOf;

  //###########################################################################################################
  CND = require('cnd');

  rpr = CND.rpr;

  badge = 'STEAMPIPES/TESTS/ASYNC';

  debug = CND.get_logger('debug', badge);

  warn = CND.get_logger('warn', badge);

  info = CND.get_logger('info', badge);

  urge = CND.get_logger('urge', badge);

  help = CND.get_logger('help', badge);

  whisper = CND.get_logger('whisper', badge);

  echo = CND.echo.bind(CND);

  //...........................................................................................................
  test = require('guy-test');

  jr = JSON.stringify;

  //...........................................................................................................
  SP = require('../..');

  ({$, $async, $watch, $drain, $show} = SP.export());

  defer = setImmediate;

  sleep = function(dts) {
    return new Promise(function(done) {
      return setTimeout(done, dts * 1000);
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  after = function(dts, f) {
    return setTimeout(f, dts * 1000);
  };

  //-----------------------------------------------------------------------------------------------------------
  this["async 0"] = async function(T, done) {
    var i, len, matcher, ok, probe, ref, use_async;
    ok = false;
    [probe, matcher] = ["abcdef", "1a-2a-1b-2b-1c-2c-1d-2d-1e-2e-1f-2f"];
    ref = [true, false];
    for (i = 0, len = ref.length; i < len; i++) {
      use_async = ref[i];
      await (() => {
        return new Promise((resolve) => {
          var pipeline;
          pipeline = [];
          pipeline.push(probe);
          // pipeline.push $watch ( d ) -> info 'µ1', jr d
          if (use_async) {
            pipeline.push($async(function(d, send, done) {
              defer(function() {
                return send(`1${d}`);
              });
              return after(0.1, function() {
                send(`2${d}`);
                return done();
              });
            }));
          } else {
            pipeline.push($(function(d, send) {
              send(`1${d}`);
              return send(`2${d}`);
            }));
          }
          // pipeline.push $watch ( d ) -> urge 'µ2', jr d
          pipeline.push(SP.$surround({
            between: '-'
          }));
          pipeline.push(SP.$join());
          //.........................................................................................................
          pipeline.push(SP.$watch(function(result) {
            echo(CND.gold(jr([probe, result])));
            T.eq(result, matcher);
            return ok = true;
          }));
          //.........................................................................................................
          pipeline.push(SP.$drain(function() {
            if (!ok) {
              T.fail("failed to pass test");
            }
            return resolve();
          }));
          //.........................................................................................................
          return SP.pull(...pipeline);
        });
      })();
    }
    done();
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  $send_three = function() {
    return $async(function(d, send, done) {
      var count, i, nr;
      count = 0;
      for (nr = i = 1; i <= 3; nr = ++i) {
        (function(d, nr) {
          var dt;
          dt = Math.random() / 10;
          return after(dt, function() {
            count += 1;
            send(`(${d}:${nr})`);
            if (count === 3) {
              return done();
            }
          });
        })(d, nr);
      }
      return null;
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  this["async 2"] = function(T, done) {
    var matcher, ok, pipeline, probe;
    ok = false;
    probe = "fdcabe";
    matcher = "(a:1)(a:2)(a:3)(b:1)(b:2)(b:3)(c:1)(c:2)(c:3)(d:1)(d:2)(d:3)(e:1)(e:2)(e:3)(f:1)(f:2)(f:3)";
    pipeline = [];
    pipeline.push(Array.from(probe));
    pipeline.push($send_three());
    // pipeline.push $show { title: '2', }
    pipeline.push(SP.$sort());
    pipeline.push(SP.$join());
    //.........................................................................................................
    pipeline.push(SP.$watch(function(result) {
      T.eq(result, matcher);
      return ok = true;
    }));
    //.........................................................................................................
    pipeline.push(SP.$watch(function(d) {
      return urge(d);
    }));
    pipeline.push(SP.$drain(function() {
      if (!ok) {
        T.fail("failed to pass test");
      }
      return done();
    }));
    //.........................................................................................................
    // T.throws /contains asynchronous transform/, -> SP.pull pipeline...
    SP.pull(...pipeline);
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  this["async 3"] = function(T, done) {
    var $multiply, matcher, probe;
    probe = [2, 3, 5, 7];
    matcher = [2, 4, 4, 3, 6, 9, 5, 10, 25, 7, 14, 49];
    //.........................................................................................................
    $multiply = function() {
      var FSP, exec;
      exec = (require('util')).promisify((require('child_process')).exec);
      FSP = (require('fs')).promises;
      return $async((d, send, done) => {
        debug('^787^', d);
        return defer(async() => {
          var text;
          send(d);
          await sleep(0.1);
          text = (await FSP.readFile(__filename, {
            encoding: 'utf-8'
          }));
          debug('^030^', jr(text.slice(100, 201)));
          send(d * 2);
          await sleep(0.1);
          debug('^3344^', jr((await exec('ls'))));
          send(d ** 2);
          await sleep(0.1);
          return done();
        });
      });
    };
    return (() => {      //.........................................................................................................
      var pipeline;
      pipeline = [];
      pipeline.push(probe);
      pipeline.push($watch((d) => {
        return help(CND.grey('before', jr(d)));
      }));
      pipeline.push($multiply());
      pipeline.push($watch((d) => {
        return help(CND.white('after ', jr(d)));
      }));
      pipeline.push($drain(function(result) {
        debug(jr(result));
        T.eq(result, matcher);
        return done();
      }));
      SP.pull(...pipeline);
      return null;
    })();
  };

  //-----------------------------------------------------------------------------------------------------------
  this["async 4 w/ async source"] = function(T, done) {
    var $frobulate;
    //.........................................................................................................
    $frobulate = function() {
      var FSP, exec;
      exec = (require('util')).promisify((require('child_process')).exec);
      FSP = (require('fs')).promises;
      return $async(async(d, send, done) => {
        var text;
        if (d !== '{') {
          send(d);
          return done();
        }
        send('async started');
        info('^787^', d);
        send(d);
        urge('before');
        text = (await FSP.readFile(__filename, {
          encoding: 'utf-8'
        }));
        urge('after');
        // info '^030^', jr text[ 100 .. 200 ]
        send('async complete');
        return done();
      });
    };
    return (async() => {      //.........................................................................................................
      var PATH, i, len, path, source, sources;
      PATH = require('path');
      path = PATH.join(__dirname, '../../package.json');
      // ( await SP._KLUDGE_file_as_buffers path         )
      sources = [SP.read_from_file(path), [(require('fs')).readFileSync(path)]];
      for (i = 0, len = sources.length; i < len; i++) {
        source = sources[i];
        await ((source) => {
          return new Promise((resolve) => {
            var pipeline;
            pipeline = [];
            pipeline.push(source);
            pipeline.push(SP.$split());
            pipeline.push($frobulate());
            // pipeline.push $show()
            pipeline.push($drain(function(result) {
              if (!(indexOf.call(result, 'async started') >= 0)) {
                T.fail("did not receive 'async started'");
              }
              if (!(indexOf.call(result, 'async complete') >= 0)) {
                T.fail("did not receive 'async complete'");
              }
              return resolve();
            }));
            return SP.pull(...pipeline);
          });
        })(source);
      }
      done();
      return null;
    })();
  };

  //###########################################################################################################
  if (module.parent == null) {
    // test @, { timeout: 10000, }
    test(this["async 4 w/ async source"]);
  }

  // test @[ "async 2" ], { timeout: 10000, }

}).call(this);

//# sourceMappingURL=async.test.js.map
