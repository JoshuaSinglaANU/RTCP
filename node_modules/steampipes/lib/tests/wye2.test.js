// Generated by CoffeeScript 2.5.1
(function() {
  //###########################################################################################################
  var $, $async, $drain, $show, $watch, CND, FS, OS, PATH, SP, alert, badge, debug, defaults, echo, help, info, isa, jr, log, rpr, test, type_of, urge, validate, warn, whisper,
    modulo = function(a, b) { return (+a % (b = +b) + b) % b; };

  CND = require('cnd');

  rpr = CND.rpr;

  badge = 'STEAMPIPES/TESTS/WYE2';

  log = CND.get_logger('plain', badge);

  info = CND.get_logger('info', badge);

  whisper = CND.get_logger('whisper', badge);

  alert = CND.get_logger('alert', badge);

  debug = CND.get_logger('debug', badge);

  warn = CND.get_logger('warn', badge);

  help = CND.get_logger('help', badge);

  urge = CND.get_logger('urge', badge);

  echo = CND.echo.bind(CND);

  //...........................................................................................................
  PATH = require('path');

  FS = require('fs');

  OS = require('os');

  test = require('guy-test');

  ({jr} = CND);

  //...........................................................................................................
  ({isa, validate, defaults, type_of} = require('../types'));

  //...........................................................................................................
  SP = require('../..');

  ({$, $async, $drain, $watch, $show} = SP.export());

  //-----------------------------------------------------------------------------------------------------------
  this["tentative implementation"] = async function(T, done) {
    var error, matcher, probe;
    [probe, matcher, error] = ["abcde", "(a)A(b)B(c)C(d)D(e)E", null];
    await T.perform(probe, matcher, error, function() {
      return new Promise(function(resolve, reject) {
        var pipeline, t1, wye;
        pipeline = [];
        t1 = $(function(d, send) {
          send(d);
          return wye.send(`(${d})`);
        });
        wye = SP.$pass();
        pipeline.push(probe);
        pipeline.push(t1);
        pipeline.push($(function(d, send) {
          return send(d.toUpperCase());
        }));
        pipeline.push(wye);
        pipeline.push($drain(function(Σ) {
          return resolve(Σ.join(''));
        }));
        SP.pull(...pipeline);
        return null;
      });
    });
    //.........................................................................................................
    done();
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  this["leapfrogging compared to wye"] = async function(T, done) {
    var error, matcher, probe, results;
    [probe, matcher, error] = ["abcde", "aBCdE", null];
    results = [];
    //.........................................................................................................
    await T.perform(probe, matcher, error, function() {
      return new Promise(function(resolve, reject) {
        var pipeline, wye;
        pipeline = [];
        pipeline.push(probe);
        pipeline.push($(function(d, send) {
          if ((d.match(/a|d/)) != null) {
            return wye.send(d);
          } else {
            return send(d);
          }
        }));
        pipeline.push($(function(d, send) {
          return send(d.toUpperCase());
        }));
        pipeline.push(wye = SP.$pass());
        pipeline.push($drain(function(Σ) {
          var R;
          results.push(R = Σ.join(''));
          return resolve(R);
        }));
        SP.pull(...pipeline);
        return null;
      });
    });
    //.........................................................................................................
    await T.perform(probe, matcher, error, function() {
      return new Promise(function(resolve, reject) {
        var leapfrog, pipeline, wye;
        leapfrog = function(d) {
          return (d.match(/a|d/)) != null;
        };
        pipeline = [];
        pipeline.push(probe);
        pipeline.push($({leapfrog}, function(d, send) {
          return send(d.toUpperCase());
        }));
        pipeline.push(wye = SP.$pass());
        pipeline.push($drain(function(Σ) {
          var R;
          results.push(R = Σ.join(''));
          return resolve(R);
        }));
        SP.pull(...pipeline);
        return null;
      });
    });
    //.........................................................................................................
    await T.perform(probe, matcher, error, function() {
      return new Promise(function(resolve, reject) {
        var pipeline, wye;
        pipeline = [];
        pipeline.push(probe);
        // pipeline.push $show()
        pipeline.push(SP.leapfrog((function(d) {
          return (d.match(/a|d/)) != null;
        }), $(function(d, send) {
          return send(d.toUpperCase());
        })));
        pipeline.push(wye = SP.$pass());
        pipeline.push($drain(function(Σ) {
          var R;
          results.push(R = Σ.join(''));
          return resolve(R);
        }));
        SP.pull(...pipeline);
        return null;
      });
    });
    //.........................................................................................................
    T.eq(results.length, 3);
    T.eq(...results);
    done();
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  this["wye 2"] = async function(T, done) {
    var error, matcher, probe;
    [probe, matcher, error] = ["a", "[a](a)A", null];
    // [ probe, matcher, error, ] = ['abcde','A(a)B(b)C(c)D(d)E(e)',null]
    await T.perform(probe, matcher, error, function() {
      return new Promise(function(resolve, reject) {
        var pipeline, t1, wye;
        t1 = $(function(d, send) {
          wye.send(`[${d}]`);
          wye.send(`(${d})`);
          return send(d);
        });
        pipeline = [];
        pipeline.push(probe);
        pipeline.push(t1);
        pipeline.push($(function(d, send) {
          return send(d.toUpperCase());
        }));
        pipeline.push(wye = SP.$pass());
        pipeline.push($drain(function(Σ) {
          return resolve(Σ.join(''));
        }));
        SP.pull(...pipeline);
        return null;
      });
    });
    //.........................................................................................................
    done();
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  this["wye 3"] = async function(T, done) {
    var error, matcher, probe;
    [probe, matcher, error] = [[24], [12, 6, 3, 10, 5, 16, 8, 4, 2, 1], null];
    // [ probe, matcher, error, ] = ['abcde','A(a)B(b)C(c)D(d)E(e)',null]
    await T.perform(probe, matcher, error, function() {
      return new Promise(function(resolve, reject) {
        var d, i, len, pipeline, source;
        source = SP.new_push_source();
        pipeline = [];
        pipeline.push(source);
        // pipeline.push wye = SP.$pass()
        // pipeline.push $show()
        pipeline.push($(function(d, send) {
          return send((modulo(d, 2) === 0) ? d / 2 : d * 3 + 1);
        }));
        pipeline.push($show());
        pipeline.push($(function(d, send) {
          send(d);
          if (d === 1) {
            return source.end();
          } else {
            return source.send(d);
          }
        }));
        pipeline.push($drain(function(Σ) {
          return resolve(Σ);
        }));
        SP.pull(...pipeline);
        for (i = 0, len = probe.length; i < len; i++) {
          d = probe[i];
          source.send(d);
        }
        return null;
      });
    });
    //.........................................................................................................
    done();
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  this["wye construction (sync)"] = async function(T, done) {
    var error, i, len, matcher, probe_A, probe_B, probes_and_matchers;
    probes_and_matchers = [[["abc", "UVWXYZ"], "abcUVWXYZ", null]];
    for (i = 0, len = probes_and_matchers.length; i < len; i++) {
      [[probe_A, probe_B], matcher, error] = probes_and_matchers[i];
      await T.perform([probe_A, probe_B], matcher, error, function() {
        return new Promise(function(resolve, reject) {
          var A_has_ended, B_has_ended, duct_A, duct_B, duct_C, end_source_C, last, pipeline_A, pipeline_B, pipeline_C, source_A, source_B, source_C;
          // wye         = SP.new_wye()
          last = Symbol('last');
          //.....................................................................................................
          source_A = probe_A;
          A_has_ended = false;
          B_has_ended = false;
          pipeline_A = [];
          pipeline_A.push(source_A);
          pipeline_A.push($watch(function(d) {
            return help('A', jr(d));
          }));
          pipeline_A.push($({last}, function(d, send) {
            if (d === last) {
              A_has_ended = true;
              return end_source_C();
            }
            return source_C.send(d);
          }));
          pipeline_A.push($drain(function() {
            return whisper('A');
          }));
          //.....................................................................................................
          source_B = probe_B;
          pipeline_B = [];
          pipeline_B.push(source_B);
          pipeline_B.push($watch(function(d) {
            return urge('B', jr(d));
          }));
          pipeline_B.push($({last}, function(d, send) {
            if (d === last) {
              B_has_ended = true;
              return end_source_C();
            }
            return source_C.send(d);
          }));
          pipeline_B.push($drain(function() {
            return whisper('B');
          }));
          //.....................................................................................................
          source_C = SP.new_push_source();
          pipeline_C = [];
          pipeline_C.push(source_C);
          pipeline_C.push($watch(function(d) {
            return info('C', jr(d));
          }));
          pipeline_C.push($drain(function(Σ) {
            whisper('C', jr(Σ));
            return resolve(Σ.join(''));
          }));
          //.....................................................................................................
          end_source_C = function() {
            if (!(A_has_ended && B_has_ended)) {
              return;
            }
            return source_C.end();
          };
          //.....................................................................................................
          // pipeline_A.push wye
          duct_C = SP.pull(...pipeline_C);
          duct_A = SP.pull(...pipeline_A);
          duct_B = SP.pull(...pipeline_B);
          return null;
        });
      });
    }
    //.........................................................................................................
    done();
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  this["wye construction (async)"] = async function(T, done) {
    var error, i, len, matcher, probe_A, probe_B, probes_and_matchers;
    probes_and_matchers = [[["abc", "UVWXYZ"], "aUbVcWXYZ", null]];
    for (i = 0, len = probes_and_matchers.length; i < len; i++) {
      [[probe_A, probe_B], matcher, error] = probes_and_matchers[i];
      await T.perform([probe_A, probe_B], matcher, error, function() {
        return new Promise(function(resolve, reject) {
          var A_has_ended, B_has_ended, duct_A, duct_B, duct_C, end_source_C, last, pipeline_A, pipeline_B, pipeline_C, source_A, source_B, source_C;
          // wye         = SP.new_wye()
          last = Symbol('last');
          //.....................................................................................................
          source_A = probe_A;
          A_has_ended = false;
          B_has_ended = false;
          pipeline_A = [];
          pipeline_A.push(source_A);
          pipeline_A.push($watch(function(d) {
            return help('A', jr(d));
          }));
          pipeline_A.push($async(function(d, send, done) {
            source_C.send(d);
            return done();
          }));
          pipeline_A.push($({last}, function(d, send) {
            if (d !== last) {
              return;
            }
            A_has_ended = true;
            return end_source_C();
          }));
          pipeline_A.push($drain(function() {
            return whisper('A');
          }));
          //.....................................................................................................
          source_B = probe_B;
          pipeline_B = [];
          pipeline_B.push(source_B);
          pipeline_B.push($watch(function(d) {
            return urge('B', jr(d));
          }));
          pipeline_B.push($async(function(d, send, done) {
            source_C.send(d);
            return done();
          }));
          pipeline_B.push($({last}, function(d, send) {
            if (d !== last) {
              return;
            }
            B_has_ended = true;
            return end_source_C();
          }));
          pipeline_B.push($drain(function() {
            return whisper('B');
          }));
          //.....................................................................................................
          source_C = SP.new_push_source();
          pipeline_C = [];
          pipeline_C.push(source_C);
          pipeline_C.push($watch(function(d) {
            return info('C', jr(d));
          }));
          pipeline_C.push($drain(function(Σ) {
            whisper('C', jr(Σ));
            return resolve(Σ.join(''));
          }));
          //.....................................................................................................
          end_source_C = function() {
            if (!(A_has_ended && B_has_ended)) {
              return;
            }
            return source_C.end();
          };
          //.....................................................................................................
          // pipeline_A.push wye
          duct_C = SP.pull(...pipeline_C);
          duct_A = SP.pull(...pipeline_A);
          duct_B = SP.pull(...pipeline_B);
          return null;
        });
      });
    }
    //.........................................................................................................
    done();
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  this["wye construction (source, transform, drain ducts)"] = async function(T, done) {
    await T.perform(null, null, null, function() {
      return new Promise(function(resolve, reject) {
        var pipeline;
        //.......................................................................................................
        pipeline = [];
        pipeline.push('abc');
        pipeline.push($watch(function(d) {
          return help('A', jr(d));
        }));
        pipeline.push(SP.new_wye('UVW'));
        pipeline.push($watch(function(d) {
          return urge('AB', jr(d));
        }));
        SP.pull(...pipeline);
        return resolve(null);
      });
    });
    //.........................................................................................................
    await T.perform(null, null, null, function() {
      return new Promise(function(resolve, reject) {
        var pipeline;
        //.......................................................................................................
        pipeline = [];
        pipeline.push($watch(function(d) {
          return help('A', jr(d));
        }));
        pipeline.push(SP.new_wye('UVW'));
        pipeline.push($watch(function(d) {
          return urge('AB', jr(d));
        }));
        SP.pull(...pipeline);
        return resolve(null);
      });
    });
    //.........................................................................................................
    await T.perform(null, null, null, function() {
      return new Promise(function(resolve, reject) {
        var pipeline;
        //.......................................................................................................
        pipeline = [];
        pipeline.push($watch(function(d) {
          return help('A', jr(d));
        }));
        pipeline.push(SP.new_wye('UVW'));
        pipeline.push($watch(function(d) {
          return urge('AB', jr(d));
        }));
        pipeline.push($drain(function() {}));
        SP.pull(...pipeline);
        return resolve(null);
      });
    });
    //.........................................................................................................
    done();
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  this["wye construction (method)"] = async function(T, done) {
    var error, i, len, matcher, probe_A, probe_B, probes_and_matchers;
    probes_and_matchers = [[["abc", "UVWXYZ"], "abcUVWXYZ", null]];
    for (i = 0, len = probes_and_matchers.length; i < len; i++) {
      [[probe_A, probe_B], matcher, error] = probes_and_matchers[i];
      await T.perform([probe_A, probe_B], matcher, error, function() {
        return new Promise(function(resolve, reject) {
          var pipeline, source_A, source_B;
          // wye         = SP.new_wye()
          //.....................................................................................................
          source_A = probe_A;
          source_B = probe_B;
          pipeline = [];
          pipeline.push(source_A);
          pipeline.push($watch(function(d) {
            return help('A', jr(d));
          }));
          pipeline.push(SP.new_wye(source_B));
          pipeline.push($watch(function(d) {
            return urge('AB', jr(d));
          }));
          pipeline.push($drain(function(Σ) {
            whisper('AB', jr(Σ));
            return resolve(Σ.join(''));
          }));
          SP.pull(...pipeline);
          return null;
        });
      });
    }
    //.........................................................................................................
    done();
    return null;
  };

  //###########################################################################################################
  if (module === require.main) {
    (() => { // await do =>
      return test(this, {
        'timeout': 30000
      });
    })();
  }

  // test @[ "leapfrogging compared to wye" ]
// test @[ "wye construction (sync)" ]
// test @[ "wye construction (async)" ]
// test @[ "wye construction (method)" ]
// test @[ "wye construction (source, transform, drain ducts)" ]

}).call(this);

//# sourceMappingURL=wye2.test.js.map
